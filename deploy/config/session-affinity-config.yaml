# Sample EPP configuration with Session Affinity using HTTP cookies
#
# This configuration demonstrates how to enable session affinity for inference requests.
# Session affinity ensures that subsequent requests from the same client are routed to
# the same pod, improving KV cache hit rates and reducing latency for multi-turn conversations.
#
# The session affinity is implemented using standard HTTP cookies (llm-d-session),
# which are automatically handled by browsers and HTTP clients without requiring
# any client-side code changes.
#
apiVersion: inference.networking.x-k8s.io/v1alpha1
kind: EndpointPickerConfig
plugins:
- type: prefix-cache-scorer
  parameters:
    hashBlockSize: 5
    maxPrefixBlocksToMatch: 256
- type: session-affinity-scorer  # Enables cookie-based session affinity
  parameters:
    # maxAge: 86400      # Optional: Cookie lifetime in seconds (default: 0 = session cookie)
    # secure: true       # Optional: Only send over HTTPS (default: false, set true in production)
    # sameSite: "Lax"    # Optional: SameSite attribute (default: "Lax", options: "Strict", "None")
- type: decode-filter
- type: max-score-picker
- type: single-profile-handler
schedulingProfiles:
- name: default
  plugins:
  - pluginRef: decode-filter
  - pluginRef: max-score-picker
  - pluginRef: session-affinity-scorer
    weight: 100  # High weight ensures session affinity takes precedence when cookie is present
  - pluginRef: prefix-cache-scorer
    weight: 50   # Still considers cache locality for initial routing

